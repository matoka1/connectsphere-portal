<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ConnectSphere WiFi Portal - Secure Internet Access">
    <title>ConnectSphere WiFi Portal</title>
    
    <!-- Production CSS -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="portal-body">
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>ConnectSphere WiFi</h2>
            <p>Loading secure portal...</p>
        </div>
    </div>

    <!-- Main Portal Container -->
    <div class="portal-container" id="mainContainer" style="display: none;">
        <!-- Navigation Bar -->
        <nav class="portal-nav">
            <div class="nav-brand">
                <i class="fas fa-wifi"></i>
                <span>ConnectSphere</span>
            </div>
            <div class="nav-links">
                <a href="#home" class="nav-link active">Home</a>
                <a href="#about" class="nav-link">About</a>
                <a href="#plans" class="nav-link">Plans</a>
                <a href="#contact" class="nav-link">Contact</a>
            </div>
            <div class="nav-actions">
                <button class="btn-outline" id="loginBtn">Login</button>
                <button class="btn-primary" id="signupBtn">Sign Up</button>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="hero-section" id="home">
            <div class="hero-content">
                <h1 class="hero-title">Welcome to ConnectSphere WiFi</h1>
                <p class="hero-subtitle">High-speed, secure internet access for homes and businesses</p>
                
                <div class="hero-stats">
                    <div class="stat-item">
                        <i class="fas fa-users"></i>
                        <div>
                            <h3 id="activeUsers">Loading...</h3>
                            <p>Active Users</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-bolt"></i>
                        <div>
                            <h3>100 Mbps</h3>
                            <p>Average Speed</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-shield-alt"></i>
                        <div>
                            <h3>99.9%</h3>
                            <p>Uptime</p>
                        </div>
                    </div>
                </div>
                
                <div class="hero-actions">
                    <button class="btn-primary btn-lg" id="connectNowBtn">
                        <i class="fas fa-wifi"></i>
                        Connect Now
                    </button>
                    <button class="btn-outline btn-lg" onclick="window.location.href='#plans'">
                        <i class="fas fa-star"></i>
                        View Plans
                    </button>
                </div>
            </div>
            
            <div class="hero-image">
                <div class="network-animation">
                    <div class="node"></div>
                    <div class="node"></div>
                    <div class="node"></div>
                    <div class="node"></div>
                    <div class="connection-line"></div>
                    <div class="connection-line"></div>
                    <div class="connection-line"></div>
                </div>
            </div>
        </section>

        <!-- Login Modal -->
        <div class="modal-overlay" id="loginModal" style="display: none;">
            <div class="modal-container">
                <div class="modal-header">
                    <h2><i class="fas fa-sign-in-alt"></i> Login to Portal</h2>
                    <button class="modal-close" onclick="closeModal('loginModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="loginEmail" placeholder="your@email.com" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" placeholder="Enter password" required>
                            <div class="password-toggle">
                                <i class="fas fa-eye" onclick="togglePassword('loginPassword')"></i>
                            </div>
                        </div>
                        <div class="form-options">
                            <label class="checkbox">
                                <input type="checkbox" id="rememberMe">
                                <span>Remember me</span>
                            </label>
                            <a href="#forgot" class="text-link">Forgot password?</a>
                        </div>
                        <button type="submit" class="btn-primary btn-block">
                            <i class="fas fa-lock"></i>
                            Login
                        </button>
                        
                        <div class="divider">
                            <span>or continue with</span>
                        </div>
                        
                        <div class="social-login">
                            <button type="button" class="social-btn google" onclick="socialLogin('google')">
                                <i class="fab fa-google"></i>
                                Google
                            </button>
                            <button type="button" class="social-btn facebook" onclick="socialLogin('facebook')">
                                <i class="fab fa-facebook"></i>
                                Facebook
                            </button>
                        </div>
                        
                        <p class="text-center">
                            Don't have an account? 
                            <a href="#" class="text-link" onclick="showSignupModal()">Sign up here</a>
                        </p>
                    </form>
                </div>
            </div>
        </div>

        <!-- Signup Modal -->
        <div class="modal-overlay" id="signupModal" style="display: none;">
            <div class="modal-container">
                <div class="modal-header">
                    <h2><i class="fas fa-user-plus"></i> Create Account</h2>
                    <button class="modal-close" onclick="closeModal('signupModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="signupForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" id="firstName" placeholder="John" required>
                            </div>
                            <div class="form-group">
                                <label>Last Name</label>
                                <input type="text" id="lastName" placeholder="Doe" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="signupEmail" placeholder="your@email.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="phoneNumber" placeholder="254700000000" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="signupPassword" placeholder="Create password" required>
                                <div class="password-toggle">
                                    <i class="fas fa-eye" onclick="togglePassword('signupPassword')"></i>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Confirm Password</label>
                                <input type="password" id="confirmPassword" placeholder="Confirm password" required>
                                <div class="password-toggle">
                                    <i class="fas fa-eye" onclick="togglePassword('confirmPassword')"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>How did you hear about us?</label>
                            <select id="referralSource">
                                <option value="">Select option</option>
                                <option value="friend">Friend/Family</option>
                                <option value="social">Social Media</option>
                                <option value="ad">Advertisement</option>
                                <option value="search">Search Engine</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox">
                                <input type="checkbox" id="termsAgreement" required>
                                <span>
                                    I agree to the <a href="#" class="text-link">Terms of Service</a> 
                                    and <a href="#" class="text-link">Privacy Policy</a>
                                </span>
                            </label>
                        </div>
                        
                        <button type="submit" class="btn-primary btn-block">
                            <i class="fas fa-user-plus"></i>
                            Create Account
                        </button>
                        
                        <p class="text-center">
                            Already have an account? 
                            <a href="#" class="text-link" onclick="showLoginModal()">Login here</a>
                        </p>
                    </form>
                </div>
            </div>
        </div>

        <!-- WiFi Connection Modal -->
        <div class="modal-overlay" id="wifiModal" style="display: none;">
            <div class="modal-container">
                <div class="modal-header">
                    <h2><i class="fas fa-wifi"></i> Connect to WiFi</h2>
                    <button class="modal-close" onclick="closeModal('wifiModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="wifi-steps">
                        <div class="step active">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>User Information</h4>
                                <p>Enter your details to connect</p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Select Plan</h4>
                                <p>Choose your access duration</p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Connect</h4>
                                <p>Get instant internet access</p>
                            </div>
                        </div>
                    </div>
                    
                    <form id="wifiConnectForm">
                        <div class="form-step active" id="step1">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="connectName" placeholder="Enter your full name" required>
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" id="connectEmail" placeholder="your@email.com" required>
                            </div>
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" id="connectPhone" placeholder="254700000000" required>
                            </div>
                            <button type="button" class="btn-primary btn-block" onclick="nextStep()">
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                        
                        <div class="form-step" id="step2">
                            <div class="form-group">
                                <label>Select Access Duration</label>
                                <div class="plan-options">
                                    <label class="plan-option">
                                        <input type="radio" name="plan" value="1" required>
                                        <div class="plan-card">
                                            <h4>1 Hour</h4>
                                            <p>Free Trial</p>
                                            <div class="plan-price">KES 0</div>
                                        </div>
                                    </label>
                                    <label class="plan-option">
                                        <input type="radio" name="plan" value="4" checked>
                                        <div class="plan-card popular">
                                            <div class="plan-badge">Most Popular</div>
                                            <h4>4 Hours</h4>
                                            <p>Standard Access</p>
                                            <div class="plan-price">KES 100</div>
                                        </div>
                                    </label>
                                    <label class="plan-option">
                                        <input type="radio" name="plan" value="8">
                                        <div class="plan-card">
                                            <h4>8 Hours</h4>
                                            <p>Extended Access</p>
                                            <div class="plan-price">KES 180</div>
                                        </div>
                                    </label>
                                    <label class="plan-option">
                                        <input type="radio" name="plan" value="24">
                                        <div class="plan-card">
                                            <h4>24 Hours</h4>
                                            <p>Premium Access</p>
                                            <div class="plan-price">KES 300</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Payment Method</label>
                                <div class="payment-options">
                                    <label class="payment-option">
                                        <input type="radio" name="payment" value="mpesa" checked required>
                                        <div class="payment-card">
                                            <i class="fas fa-mobile-alt"></i>
                                            <span>M-Pesa</span>
                                        </div>
                                    </label>
                                    <label class="payment-option">
                                        <input type="radio" name="payment" value="card">
                                        <div class="payment-card">
                                            <i class="fas fa-credit-card"></i>
                                            <span>Card</span>
                                        </div>
                                    </label>
                                    <label class="payment-option">
                                        <input type="radio" name="payment" value="voucher">
                                        <div class="payment-card">
                                            <i class="fas fa-ticket-alt"></i>
                                            <span>Voucher</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn-outline" onclick="prevStep()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button type="button" class="btn-primary" onclick="nextStep()">
                                    Next <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-step" id="step3">
                            <div class="connection-summary">
                                <h4><i class="fas fa-check-circle"></i> Ready to Connect</h4>
                                <div class="summary-details">
                                    <div class="summary-item">
                                        <span>Name:</span>
                                        <span id="summaryName">-</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Email:</span>
                                        <span id="summaryEmail">-</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Phone:</span>
                                        <span id="summaryPhone">-</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Duration:</span>
                                        <span id="summaryDuration">-</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Payment:</span>
                                        <span id="summaryPayment">-</span>
                                    </div>
                                    <div class="summary-item total">
                                        <span>Amount:</span>
                                        <span id="summaryAmount">KES 0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox">
                                    <input type="checkbox" id="wifiTerms" required>
                                    <span>
                                        I agree that my connection may be monitored for security purposes
                                        and I accept the <a href="#" class="text-link">Fair Usage Policy</a>
                                    </span>
                                </label>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn-outline" onclick="prevStep()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-wifi"></i> Connect Now
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Plans Section -->
        <section class="plans-section" id="plans">
            <div class="section-header">
                <h2>Internet Plans</h2>
                <p>Choose the perfect plan for your needs</p>
            </div>
            
            <div class="plans-grid">
                <div class="plan-card">
                    <div class="plan-header">
                        <h3>Basic</h3>
                        <div class="plan-price">
                            <span class="amount">KES 1,500</span>
                            <span class="period">/month</span>
                        </div>
                    </div>
                    <div class="plan-features">
                        <div class="feature">
                            <i class="fas fa-check"></i>
                            <span>25 Mbps Speed</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-check"></i>
                            <span>100 GB Data</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-check"></i>
                            <span>5 Devices</span>
                        </div>
                        <div class="feature disabled">
                            <i class="fas fa-times"></i>
                            <span>Priority Support</span>
                        </div>
                    </div>
                    <button class="btn-outline btn-block" onclick="selectPlan('basic')">
                        Select Plan
                    </button>
                </div>
                
                <div class="plan-card popular">
                    <div class="plan-badge">Most Popular</div>
                    <div class="plan-header">
                        <h3>Standard</h3>
                        <div class="plan-price">
                            <span class="amount">KES 2,500</span>
                            <span class="period">/month</span>
                        </div>
                    </div>
                    <div class="plan-features">
                        <div class="feature">
                            <i class="fas fa-check"></i>
                            <span>50 Mbps Speed</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-check"></i>
                            <span>250 GB Data</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-check"></i>
                            <span>10 Devices</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-check"></i>
                            <span>Basic Support</span>
                        </div>
                    </div>
                    <button class="btn-primary btn-block" onclick="selectPlan('standard')">
                        Select Plan
                    </button>
                </div>
                
                <div class="plan-card">
                    <div class="plan-header">
                        <h3>Premium</h3>
                        <div class="plan-price">
                            <span class="amount">KES 4,000</span>
                            <span class="period">/month</span>
                        </div>
                    </div>
                    <div class="plan-features">
                        <div class="feature">
                            <i class="fas fa-check"></i>
                            <span>100 Mbps Speed</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-check"></i>
                            <span>Unlimited Data</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-check"></i>
                            <span>20 Devices</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-check"></i>
                            <span>Priority Support</span>
                        </div>
                    </div>
                    <button class="btn-outline btn-block" onclick="selectPlan('premium')">
                        Select Plan
                    </button>
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section class="about-section" id="about">
            <div class="section-header">
                <h2>Why Choose ConnectSphere?</h2>
                <p>Reliable internet for homes and businesses</p>
            </div>
            
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h3>High Speed</h3>
                    <p>Experience blazing fast internet with speeds up to 100Mbps</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3>Secure</h3>
                    <p>Enterprise-grade security and encrypted connections</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    <h3>24/7 Support</h3>
                    <p>Round-the-clock customer support and technical assistance</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>No Throttling</h3>
                    <p>Consistent speeds with no bandwidth throttling</p>
                </div>
            </div>
        </section>

        <!-- Contact Section -->
        <section class="contact-section" id="contact">
            <div class="section-header">
                <h2>Contact Us</h2>
                <p>Get in touch for support or inquiries</p>
            </div>
            
            <div class="contact-grid">
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <div>
                            <h4>Call Us</h4>
                            <p>+254 700 000 000</p>
                        </div>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <div>
                            <h4>Email Us</h4>
                            <p>support@connectsphere.co.ke</p>
                        </div>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <div>
                            <h4>Visit Us</h4>
                            <p>Nairobi, Kenya</p>
                        </div>
                    </div>
                </div>
                
                <form class="contact-form" id="contactForm">
                    <div class="form-group">
                        <input type="text" placeholder="Your Name" required>
                    </div>
                    <div class="form-group">
                        <input type="email" placeholder="Your Email" required>
                    </div>
                    <div class="form-group">
                        <input type="text" placeholder="Subject" required>
                    </div>
                    <div class="form-group">
                        <textarea placeholder="Your Message" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane"></i>
                        Send Message
                    </button>
                </form>
            </div>
        </section>

        <!-- Footer -->
        <footer class="portal-footer">
            <div class="footer-content">
                <div class="footer-brand">
                    <i class="fas fa-wifi"></i>
                    <span>ConnectSphere</span>
                </div>
                
                <div class="footer-links">
                    <div class="link-group">
                        <h4>Company</h4>
                        <a href="#">About Us</a>
                        <a href="#">Careers</a>
                        <a href="#">Blog</a>
                    </div>
                    <div class="link-group">
                        <h4>Support</h4>
                        <a href="#">Help Center</a>
                        <a href="#">Contact Us</a>
                        <a href="#">Status</a>
                    </div>
                    <div class="link-group">
                        <h4>Legal</h4>
                        <a href="#">Privacy Policy</a>
                        <a href="#">Terms of Service</a>
                        <a href="#">Cookie Policy</a>
                    </div>
                </div>
                
                <div class="footer-social">
                    <a href="#" class="social-icon"><i class="fab fa-facebook"></i></a>
                    <a href="#" class="social-icon"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-icon"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="social-icon"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 ConnectSphere WiFi. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Production JavaScript -->
    <script>
        // Configuration
        const CONFIG = {
            SUPABASE_URL: 'https://uadbyyaxlieemfaofode.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhZGJ5eWF4bGllZW1mYW9mb2RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MDMyODUsImV4cCI6MjA4MTM3OTI4NX0.Gh3J0GpdQ8yXU-976JNjJKuY6rkBvn3Vkllq2vz37No',
            API_ENDPOINT: 'https://api.connectsphere.co.ke',
            PORTAL_ID: 'MAIN_PORTAL'
        };

        // Initialize Supabase
        const supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        
        // Global State
        const AppState = {
            user: null,
            session: null,
            currentStep: 1,
            connectionData: {}
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupEventListeners();
            loadActiveUsers();
        });

        function initializeApp() {
            // Check existing session
            checkExistingSession();
            
            // Hide loading screen after 1.5s
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
            }, 1500);
        }

        function setupEventListeners() {
            // Login/Signup buttons
            document.getElementById('loginBtn').addEventListener('click', showLoginModal);
            document.getElementById('signupBtn').addEventListener('click', showSignupModal);
            document.getElementById('connectNowBtn').addEventListener('click', showWifiModal);
            
            // Forms
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('wifiConnectForm').addEventListener('submit', handleWifiConnection);
            document.getElementById('contactForm').addEventListener('submit', handleContact);
            
            // Plan selection
            document.querySelectorAll('.plan-options input').forEach(radio => {
                radio.addEventListener('change', updateConnectionSummary);
            });
            
            // Real-time validation
            setupFormValidation();
        }

        // Modal Functions
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function showSignupModal() {
            document.getElementById('signupModal').style.display = 'flex';
        }

        function showWifiModal() {
            // Check if user is logged in
            if (!AppState.user) {
                showLoginModal();
                return;
            }
            document.getElementById('wifiModal').style.display = 'flex';
            resetWifiForm();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // WiFi Connection Steps
        function nextStep() {
            if (AppState.currentStep === 1) {
                // Validate step 1
                const name = document.getElementById('connectName').value;
                const email = document.getElementById('connectEmail').value;
                const phone = document.getElementById('connectPhone').value;
                
                if (!name || !email || !phone) {
                    showNotification('Please fill all required fields', 'error');
                    return;
                }
                
                AppState.connectionData = { name, email, phone };
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');
                document.querySelectorAll('.step')[0].classList.remove('active');
                document.querySelectorAll('.step')[1].classList.add('active');
                AppState.currentStep = 2;
                updateConnectionSummary();
                
            } else if (AppState.currentStep === 2) {
                // Validate step 2
                const plan = document.querySelector('input[name="plan"]:checked');
                const payment = document.querySelector('input[name="payment"]:checked');
                
                if (!plan || !payment) {
                    showNotification('Please select a plan and payment method', 'error');
                    return;
                }
                
                AppState.connectionData.plan = plan.value;
                AppState.connectionData.payment = payment.value;
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step3').classList.add('active');
                document.querySelectorAll('.step')[1].classList.remove('active');
                document.querySelectorAll('.step')[2].classList.add('active');
                AppState.currentStep = 3;
                updateConnectionSummary();
            }
        }

        function prevStep() {
            if (AppState.currentStep === 2) {
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step1').classList.add('active');
                document.querySelectorAll('.step')[1].classList.remove('active');
                document.querySelectorAll('.step')[0].classList.add('active');
                AppState.currentStep = 1;
                
            } else if (AppState.currentStep === 3) {
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step2').classList.add('active');
                document.querySelectorAll('.step')[2].classList.remove('active');
                document.querySelectorAll('.step')[1].classList.add('active');
                AppState.currentStep = 2;
            }
        }

        function resetWifiForm() {
            AppState.currentStep = 1;
            AppState.connectionData = {};
            
            // Reset steps
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.toggle('active', index === 0);
            });
            
            document.querySelectorAll('.form-step').forEach((step, index) => {
                step.classList.toggle('active', index === 0);
            });
            
            // Reset form
            document.getElementById('wifiConnectForm').reset();
            updateConnectionSummary();
        }

        function updateConnectionSummary() {
            // Update summary in step 3
            document.getElementById('summaryName').textContent = AppState.connectionData.name || '-';
            document.getElementById('summaryEmail').textContent = AppState.connectionData.email || '-';
            document.getElementById('summaryPhone').textContent = AppState.connectionData.phone || '-';
            
            // Get selected plan details
            const plan = document.querySelector('input[name="plan"]:checked');
            if (plan) {
                const planText = {
                    '1': '1 Hour - Free',
                    '4': '4 Hours - Standard',
                    '8': '8 Hours - Extended',
                    '24': '24 Hours - Premium'
                }[plan.value];
                document.getElementById('summaryDuration').textContent = planText || '-';
                
                // Calculate amount
                const prices = { '1': 0, '4': 100, '8': 180, '24': 300 };
                document.getElementById('summaryAmount').textContent = `KES ${prices[plan.value] || 0}`;
            }
            
            // Payment method
            const payment = document.querySelector('input[name="payment"]:checked');
            if (payment) {
                const paymentText = {
                    'mpesa': 'M-Pesa',
                    'card': 'Credit/Debit Card',
                    'voucher': 'Voucher'
                }[payment.value];
                document.getElementById('summaryPayment').textContent = paymentText || '-';
            }
        }

        // Authentication Functions
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                // Authenticate with Supabase
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                AppState.user = data.user;
                AppState.session = data.session;
                
                showNotification('Login successful!', 'success');
                closeModal('loginModal');
                
                // Update UI for logged-in user
                updateUserUI();
                
            } catch (error) {
                showNotification('Login failed: ' + error.message, 'error');
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('signupEmail').value;
            const phone = document.getElementById('phoneNumber').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validation
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            try {
                // Create user in Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            first_name: firstName,
                            last_name: lastName,
                            phone: phone,
                            full_name: `${firstName} ${lastName}`
                        }
                    }
                });
                
                if (authError) throw authError;
                
                // Create user profile in database
                const { error: profileError } = await supabase
                    .from('users')
                    .insert([{
                        id: authData.user.id,
                        email: email,
                        first_name: firstName,
                        last_name: lastName,
                        phone: phone,
                        created_at: new Date().toISOString()
                    }]);
                
                if (profileError) throw profileError;
                
                showNotification('Account created successfully! Please check your email to verify.', 'success');
                closeModal('signupModal');
                
            } catch (error) {
                showNotification('Signup failed: ' + error.message, 'error');
            }
        }

        // WiFi Connection Function
        async function handleWifiConnection(e) {
            e.preventDefault();
            
            if (!document.getElementById('wifiTerms').checked) {
                showNotification('Please accept the terms and conditions', 'error');
                return;
            }
            
            try {
                // Show connecting state
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
                submitBtn.disabled = true;
                
                // Get MAC address (simulated for production)
                const macAddress = await getDeviceMacAddress();
                const ipAddress = await getClientIP();
                
                // Prepare connection data
                const connectionData = {
                    ...AppState.connectionData,
                    mac_address: macAddress,
                    ip_address: ipAddress,
                    device_info: getDeviceInfo(),
                    user_id: AppState.user?.id || 'guest',
                    status: 'pending',
                    created_at: new Date().toISOString()
                };
                
                // Save to Supabase
                const { data, error } = await supabase
                    .from('wifi_connections')
                    .insert([connectionData])
                    .select();
                
                if (error) throw error;
                
                // Process payment based on selected method
                const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
                await processPayment(paymentMethod, connectionData);
                
                // Grant network access (integrate with your router API here)
                await grantNetworkAccess(macAddress, connectionData.plan);
                
                showNotification('Connected successfully! You now have internet access.', 'success');
                
                // Update active users count
                loadActiveUsers();
                
                // Close modal and reset
                setTimeout(() => {
                    closeModal('wifiModal');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                showNotification('Connection failed: ' + error.message, 'error');
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-wifi"></i> Connect Now';
                submitBtn.disabled = false;
            }
        }

        // Utility Functions
        async function getDeviceMacAddress() {
            // In production, use appropriate method for MAC address
            // This is a fallback for browsers that don't support it
            let mac = localStorage.getItem('device_mac');
            if (!mac) {
                mac = 'CS-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('device_mac', mac);
            }
            return mac;
        }

        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'unknown';
            }
        }

        function getDeviceInfo() {
            return {
                user_agent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screen: `${screen.width}x${screen.height}`,
                cookies: navigator.cookieEnabled
            };
        }

        async function processPayment(method, data) {
            // Implement payment processing based on method
            switch(method) {
                case 'mpesa':
                    // Call M-Pesa API
                    console.log('Processing M-Pesa payment...');
                    break;
                case 'card':
                    // Call payment gateway
                    console.log('Processing card payment...');
                    break;
                case 'voucher':
                    // Validate voucher
                    console.log('Processing voucher...');
                    break;
            }
        }

        async function grantNetworkAccess(macAddress, duration) {
            // Integrate with your router/firewall API
            // Example: Mikrotik, Ubiquiti, OpenWRT, etc.
            console.log(`Granting ${duration} hours access to MAC: ${macAddress}`);
            
            // This is where you'd call your router's API
            // Example for Mikrotik:
            // await fetch('/api/router/grant-access', {
            //     method: 'POST',
            //     body: JSON.stringify({ mac: macAddress, hours: duration })
            // });
        }

        async function loadActiveUsers() {
            try {
                const { count, error } = await supabase
                    .from('wifi_connections')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'active');
                
                if (!error && count !== null) {
                    document.getElementById('activeUsers').textContent = count;
                }
            } catch (error) {
                console.error('Error loading active users:', error);
            }
        }

        function checkExistingSession() {
            const session = JSON.parse(localStorage.getItem('cs_session'));
            if (session && session.expires > Date.now()) {
                AppState.user = session.user;
                updateUserUI();
            }
        }

        function updateUserUI() {
            if (AppState.user) {
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('signupBtn').style.display = 'none';
                
                const userMenu = document.createElement('div');
                userMenu.className = 'user-menu';
                userMenu.innerHTML = `
                    <button class="user-btn">
                        <i class="fas fa-user-circle"></i>
                        ${AppState.user.email.split('@')[0]}
                    </button>
                    <div class="user-dropdown">
                        <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                        <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
                        <div class="divider"></div>
                        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                `;
                
                document.querySelector('.nav-actions').appendChild(userMenu);
            }
        }

        async function handleContact(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                // Save contact message to Supabase
                const { error } = await supabase
                    .from('contact_messages')
                    .insert([{
                        ...data,
                        created_at: new Date().toISOString(),
                        status: 'pending'
                    }]);
                
                if (error) throw error;
                
                showNotification('Message sent successfully! We\'ll get back to you soon.', 'success');
                e.target.reset();
                
            } catch (error) {
                showNotification('Failed to send message: ' + error.message, 'error');
            }
        }

        function selectPlan(plan) {
            showWifiModal();
            // Auto-select the corresponding plan
            setTimeout(() => {
                const planValue = { basic: '1', standard: '4', premium: '24' }[plan];
                document.querySelector(`input[value="${planValue}"]`).checked = true;
                updateConnectionSummary();
            }, 300);
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = event.target;
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function setupFormValidation() {
            // Real-time password validation
            document.getElementById('signupPassword')?.addEventListener('input', validatePassword);
        }

        function validatePassword() {
            const password = document.getElementById('signupPassword').value;
            // Add password strength validation here
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function socialLogin(provider) {
            supabase.auth.signInWithOAuth({
                provider: provider,
                options: {
                    redirectTo: window.location.origin + '/auth/callback.html'
                }
            });
        }

        async function logout() {
            try {
                await supabase.auth.signOut();
                AppState.user = null;
                AppState.session = null;
                localStorage.removeItem('cs_session');
                window.location.reload();
            } catch (error) {
                showNotification('Logout failed: ' + error.message, 'error');
            }
        }

        // Handle smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                if (targetId === '#') return;
                
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
</body>
</html>
