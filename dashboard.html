<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ConnectSphere</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="cs-loading-screen">
        <div class="cs-loading-content">
            <div class="cs-loading-spinner"></div>
            <h2>ConnectSphere Portal</h2>
            <p>Loading Dashboard...</p>
        </div>
    </div>

    <!-- Notification Center -->
    <div id="notificationCenter"></div>

    <!-- Main App -->
    <div id="app" style="display: none;">
        <!-- Navigation -->
        <nav class="cs-navbar">
            <div class="cs-navbar-brand">
                <div class="cs-brand-logo">
                    <i class="fas fa-globe"></i>
                </div>
                <div class="cs-brand-text">
                    <h2>ConnectSphere</h2>
                    <p>Enterprise WiFi</p>
                </div>
            </div>
            
            <div class="cs-navbar-search">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search dashboard...">
            </div>
            
            <div class="cs-navbar-menu">
                <a href="index.html" class="cs-nav-item">
                    <i class="fas fa-home"></i>
                    <span>Portal</span>
                </a>
                <a href="dashboard.html" class="cs-nav-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="services.html" class="cs-nav-item">
                    <i class="fas fa-wifi"></i>
                    <span>Services</span>
                </a>
                <a href="billing.html" class="cs-nav-item">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Billing</span>
                </a>
                <a href="tickets.html" class="cs-nav-item">
                    <i class="fas fa-headset"></i>
                    <span>Support</span>
                    <span class="cs-notification-badge">3</span>
                </a>
                
                <div class="cs-user-menu">
                    <div class="cs-user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="cs-user-info">
                        <span id="navUserName">Loading...</span>
                        <span class="cs-user-role">Premium User</span>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                    <div class="cs-dropdown-menu">
                        <a href="profile.html"><i class="fas fa-user"></i> My Profile</a>
                        <a href="#"><i class="fas fa-cog"></i> Settings</a>
                        <a href="#"><i class="fas fa-bell"></i> Notifications</a>
                        <div class="cs-divider"></div>
                        <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
            </div>
            
            <button class="cs-mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="cs-main-content">
            <div class="cs-container">
                <!-- Dashboard Header -->
                <div class="cs-dashboard-header">
                    <div class="cs-header-content">
                        <h1><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h1>
                        <p>Welcome back, <span id="userName">User</span>! Here's your connection performance summary.</p>
                    </div>
                    <div class="cs-header-actions">
                        <button class="cs-btn cs-btn-primary" id="refreshBtn">
                            <i class="fas fa-redo"></i> Refresh
                        </button>
                        <button class="cs-btn cs-btn-outline" id="exportBtn">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>

                <!-- Real-time Stats -->
                <div class="cs-stats-grid">
                    <div class="cs-stat-card primary">
                        <div class="cs-stat-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="cs-stat-content">
                            <div class="cs-stat-value">
                                <span id="currentSpeed">--</span>
                                <span class="cs-stat-trend up">+2.4%</span>
                            </div>
                            <p class="cs-stat-label">Current Speed</p>
                            <div class="cs-stat-subtext">
                                <i class="fas fa-arrow-up"></i> <span id="uploadSpeed">--</span> Upload
                            </div>
                        </div>
                        <div class="cs-stat-chart" id="speedMiniChart"></div>
                    </div>
                    
                    <div class="cs-stat-card success">
                        <div class="cs-stat-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="cs-stat-content">
                            <div class="cs-stat-value">
                                <span id="dataUsed">-- GB</span>
                                <span class="cs-stat-trend up">+1.2 GB</span>
                            </div>
                            <p class="cs-stat-label">Data Used Today</p>
                            <div class="cs-stat-subtext">
                                <span id="dataRemaining">-- GB</span> remaining
                            </div>
                        </div>
                        <div class="cs-progress-bar">
                            <div class="cs-progress-fill" id="dataProgress"></div>
                        </div>
                    </div>
                    
                    <div class="cs-stat-card warning">
                        <div class="cs-stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="cs-stat-content">
                            <div class="cs-stat-value">
                                <span id="uptime">99.8%</span>
                                <span class="cs-stat-trend stable">Â±0.1%</span>
                            </div>
                            <p class="cs-stat-label">Network Uptime</p>
                            <div class="cs-stat-subtext">
                                Last downtime: <span id="lastDowntime">2 days ago</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cs-stat-card info">
                        <div class="cs-stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="cs-stat-content">
                            <div class="cs-stat-value">
                                <span id="daysLeft">15</span>
                                <span class="cs-stat-trend down">Ends soon</span>
                            </div>
                            <p class="cs-stat-label">Billing Cycle</p>
                            <div class="cs-stat-subtext">
                                Renews on: <span id="renewalDate">Jan 15, 2024</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Charts Section -->
                <div class="cs-charts-section">
                    <div class="cs-chart-main">
                        <div class="cs-chart-header">
                            <h3><i class="fas fa-chart-line"></i> Network Performance</h3>
                            <div class="cs-chart-controls">
                                <select id="timeRange" class="cs-select">
                                    <option value="1h">Last Hour</option>
                                    <option value="24h">24 Hours</option>
                                    <option value="7d" selected>7 Days</option>
                                    <option value="30d">30 Days</option>
                                </select>
                                <div class="cs-chart-legend">
                                    <span class="cs-legend-item"><i class="fas fa-circle" style="color: #0066FF;"></i> Download</span>
                                    <span class="cs-legend-item"><i class="fas fa-circle" style="color: #00D4AA;"></i> Upload</span>
                                    <span class="cs-legend-item"><i class="fas fa-circle" style="color: #FF6B6B;"></i> Latency</span>
                                </div>
                            </div>
                        </div>
                        <div id="performanceChart" style="height: 320px;"></div>
                    </div>
                    
                    <div class="cs-chart-sidebar">
                        <div class="cs-chart-container">
                            <div class="cs-chart-header">
                                <h3><i class="fas fa-signal"></i> Live Connection</h3>
                            </div>
                            <div class="cs-connection-status">
                                <div class="cs-status-indicator large" id="statusIndicator">
                                    <div class="cs-status-pulse"></div>
                                    <i class="fas fa-wifi"></i>
                                    <span id="statusText">Connected</span>
                                </div>
                                <div class="cs-connection-details">
                                    <div class="cs-detail-item">
                                        <span class="cs-detail-label">IP Address</span>
                                        <span class="cs-detail-value" id="ipAddress">--</span>
                                    </div>
                                    <div class="cs-detail-item">
                                        <span class="cs-detail-label">Signal Strength</span>
                                        <div class="cs-signal-meter">
                                            <div class="cs-signal-bars">
                                                <div class="cs-signal-bar active"></div>
                                                <div class="cs-signal-bar active"></div>
                                                <div class="cs-signal-bar active"></div>
                                                <div class="cs-signal-bar"></div>
                                            </div>
                                            <span class="cs-signal-value">Strong</span>
                                        </div>
                                    </div>
                                    <div class="cs-detail-item">
                                        <span class="cs-detail-label">Connected For</span>
                                        <span class="cs-detail-value" id="connectedSince">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="cs-chart-container">
                            <div class="cs-chart-header">
                                <h3><i class="fas fa-mobile-alt"></i> Device Usage</h3>
                            </div>
                            <div id="deviceChart" style="height: 200px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Data Usage & Speed Test -->
                <div class="cs-dashboard-grid">
                    <div class="cs-data-usage-card">
                        <div class="cs-chart-header">
                            <h3><i class="fas fa-chart-pie"></i> Data Usage Breakdown</h3>
                            <select id="usagePeriod" class="cs-select small">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month" selected>This Month</option>
                            </select>
                        </div>
                        <div class="cs-usage-breakdown">
                            <div id="usageChart" style="height: 280px;"></div>
                            <div class="cs-usage-legend">
                                <div class="cs-legend-item">
                                    <span class="cs-legend-color" style="background: #0066FF;"></span>
                                    <span class="cs-legend-text">Streaming</span>
                                    <span class="cs-legend-value">45%</span>
                                </div>
                                <div class="cs-legend-item">
                                    <span class="cs-legend-color" style="background: #00D4AA;"></span>
                                    <span class="cs-legend-text">Downloads</span>
                                    <span class="cs-legend-value">25%</span>
                                </div>
                                <div class="cs-legend-item">
                                    <span class="cs-legend-color" style="background: #FFB800;"></span>
                                    <span class="cs-legend-text">Web Browsing</span>
                                    <span class="cs-legend-value">15%</span>
                                </div>
                                <div class="cs-legend-item">
                                    <span class="cs-legend-color" style="background: #FF6B6B;"></span>
                                    <span class="cs-legend-text">Gaming</span>
                                    <span class="cs-legend-value">10%</span>
                                </div>
                                <div class="cs-legend-item">
                                    <span class="cs-legend-color" style="background: #9B51E0;"></span>
                                    <span class="cs-legend-text">Other</span>
                                    <span class="cs-legend-value">5%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cs-speed-test-card">
                        <div class="cs-chart-header">
                            <h3><i class="fas fa-tachometer-alt"></i> Speed Test</h3>
                            <button class="cs-btn cs-btn-primary" id="speedTestBtn">
                                <i class="fas fa-play"></i> Run Test
                            </button>
                        </div>
                        <div class="cs-speed-test-panel">
                            <div class="cs-speed-test-result" id="speedTestResult">
                                <div class="cs-speed-meter">
                                    <div class="cs-speed-gauge">
                                        <div class="cs-gauge-circle">
                                            <span class="cs-gauge-value" id="downloadSpeed">--</span>
                                            <span class="cs-gauge-label">Download</span>
                                        </div>
                                        <div class="cs-gauge-circle">
                                            <span class="cs-gauge-value" id="uploadSpeedGauge">--</span>
                                            <span class="cs-gauge-label">Upload</span>
                                        </div>
                                    </div>
                                    <div class="cs-speed-details">
                                        <div class="cs-detail-row">
                                            <span class="cs-detail-label">Ping</span>
                                            <span class="cs-detail-value" id="pingValue">-- ms</span>
                                        </div>
                                        <div class="cs-detail-row">
                                            <span class="cs-detail-label">Jitter</span>
                                            <span class="cs-detail-value" id="jitterValue">-- ms</span>
                                        </div>
                                        <div class="cs-detail-row">
                                            <span class="cs-detail-label">Server</span>
                                            <span class="cs-detail-value">Nairobi, KE</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="cs-speed-history">
                                <h4>Recent Tests</h4>
                                <div class="cs-history-list" id="speedHistoryList">
                                    <!-- History items will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity & Alerts -->
                <div class="cs-activity-section">
                    <div class="cs-recent-activity">
                        <div class="cs-section-header">
                            <h3><i class="fas fa-history"></i> Recent Activity</h3>
                            <a href="tickets.html" class="cs-view-all">View All</a>
                        </div>
                        <div class="cs-activity-timeline" id="activityTimeline">
                            <!-- Activity items will be populated here -->
                        </div>
                    </div>
                    
                    <div class="cs-alerts-panel">
                        <div class="cs-section-header">
                            <h3><i class="fas fa-bell"></i> System Alerts</h3>
                            <span class="cs-alert-badge">3 New</span>
                        </div>
                        <div class="cs-alerts-list" id="alertsList">
                            <!-- Alerts will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="cs-quick-actions-panel">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                    <div class="cs-action-grid">
                        <button class="cs-action-card" id="topUpBtn">
                            <div class="cs-action-icon">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <div class="cs-action-content">
                                <h4>Top Up Data</h4>
                                <p>Add more data to your plan</p>
                            </div>
                            <i class="fas fa-chevron-right cs-action-arrow"></i>
                        </button>
                        
                        <button class="cs-action-card" id="invoiceBtn">
                            <div class="cs-action-icon">
                                <i class="fas fa-file-invoice"></i>
                            </div>
                            <div class="cs-action-content">
                                <h4>View Invoice</h4>
                                <p>Download recent invoices</p>
                            </div>
                            <i class="fas fa-chevron-right cs-action-arrow"></i>
                        </button>
                        
                        <button class="cs-action-card" id="supportBtn">
                            <div class="cs-action-icon">
                                <i class="fas fa-headset"></i>
                            </div>
                            <div class="cs-action-content">
                                <h4>Get Help</h4>
                                <p>Contact support team</p>
                            </div>
                            <i class="fas fa-chevron-right cs-action-arrow"></i>
                        </button>
                        
                        <button class="cs-action-card" id="devicesBtn">
                            <div class="cs-action-icon">
                                <i class="fas fa-laptop"></i>
                            </div>
                            <div class="cs-action-content">
                                <h4>Manage Devices</h4>
                                <p>View connected devices</p>
                            </div>
                            <i class="fas fa-chevron-right cs-action-arrow"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="cs-footer">
            <div class="cs-footer-content">
                <div class="cs-footer-logo">
                    <i class="fas fa-wifi"></i>
                    <span>ConnectSphere</span>
                </div>
                <div class="cs-footer-links">
                    <a href="#">Terms</a>
                    <a href="#">Privacy</a>
                    <a href="#">Contact</a>
                    <a href="#">Support</a>
                    <a href="#">API</a>
                </div>
                <div class="cs-footer-info">
                    <p>Â© 2024 ConnectSphere. All rights reserved.</p>
                    <p class="cs-footer-version">v2.1.4</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://uadbyyaxlieemfaofode.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhZGJ5eWF4bGllZW1mYW9mb2RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MDMyODUsImV4cCI6MjA4MTM3OTI4NX0.Gh3J0GpdQ8yXU-976JNjJKuY6rkBvn3Vkllq2vz37No';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Global Variables
        let currentUser = null;
        let userConnections = [];
        let userActivity = [];
        let speedTestHistory = [];
        let usageHistory = [];
        let charts = {};

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸš€ Initializing ConnectSphere Dashboard...');
            
            try {
                // Check authentication
                await checkAuth();
                
                // Load all dashboard data
                await loadDashboardData();
                
                // Initialize charts
                initializeAllCharts();
                
                // Set up event listeners
                setupEventListeners();
                
                // Start real-time updates
                startRealTimeUpdates();
                
                // Hide loading screen, show app
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                console.log('âœ… Dashboard initialized successfully');
                
            } catch (error) {
                console.error('âŒ Dashboard initialization failed:', error);
                showError('Failed to load dashboard. Please refresh the page.');
            }
        });

        // Authentication Check
        async function checkAuth() {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error || !session) {
                console.error('âŒ No valid session found:', error);
                // Redirect to login page
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = session.user;
            console.log('âœ… User authenticated:', currentUser.email);
            
            // Update user name display
            const { data: userProfile } = await supabase
                .from('users')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            let userName = 'User';
            if (userProfile) {
                userName = `${userProfile.first_name} ${userProfile.last_name}`.trim();
            } else if (currentUser.user_metadata?.full_name) {
                userName = currentUser.user_metadata.full_name;
            } else if (currentUser.user_metadata?.first_name) {
                userName = currentUser.user_metadata.first_name;
            } else {
                userName = currentUser.email.split('@')[0];
            }
            
            document.getElementById('userName').textContent = userName;
            document.getElementById('navUserName').textContent = userName.split(' ')[0];
        }

        // Load Dashboard Data
        async function loadDashboardData() {
            console.log('ðŸ“Š Loading dashboard data...');
            
            if (!currentUser) {
                throw new Error('User not authenticated');
            }
            
            try {
                // Load all data in parallel
                await Promise.all([
                    loadConnections(),
                    loadSpeedTests(),
                    loadUsageData(),
                    loadUserActivity(),
                    loadAlerts()
                ]);
                
                // Update all UI components
                updateRealTimeStats();
                updateConnectionStatus();
                updateActivityTimeline();
                updateSpeedHistory();
                updateAlertsList();
                
            } catch (error) {
                console.error('âŒ Error loading dashboard data:', error);
                throw error;
            }
        }

        // Load Connections
        async function loadConnections() {
            try {
                const { data, error } = await supabase
                    .from('wifi_connections')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) throw error;
                userConnections = data || [];
                
            } catch (error) {
                console.error('âŒ Error loading connections:', error);
            }
        }

        // Load Speed Tests
        async function loadSpeedTests() {
            try {
                const { data, error } = await supabase
                    .from('speed_tests')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(6);
                
                if (error) {
                    console.warn('âš ï¸ Speed tests not available:', error.message);
                    // Generate simulated data
                    speedTestHistory = generateSpeedTestData();
                    return;
                }
                
                if (data && data.length > 0) {
                    speedTestHistory = data;
                } else {
                    speedTestHistory = generateSpeedTestData();
                }
                
            } catch (error) {
                console.error('âŒ Error loading speed tests:', error);
                speedTestHistory = generateSpeedTestData();
            }
        }

        // Load Usage Data
        async function loadUsageData() {
            try {
                const { data, error } = await supabase
                    .from('data_usage')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('date', { ascending: true })
                    .limit(30);
                
                if (error) {
                    console.warn('âš ï¸ Usage data not available:', error.message);
                    usageHistory = generateUsageData();
                    return;
                }
                
                usageHistory = data || generateUsageData();
                
            } catch (error) {
                console.error('âŒ Error loading usage data:', error);
                usageHistory = generateUsageData();
            }
        }

        // Load User Activity
        async function loadUserActivity() {
            try {
                // Combine connections, speed tests, and payments
                const { data: connections } = await supabase
                    .from('wifi_connections')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                const { data: speedTests } = await supabase
                    .from('speed_tests')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                const { data: payments } = await supabase
                    .from('payments')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                userActivity = [];
                
                // Add connections
                if (connections) {
                    connections.forEach(conn => {
                        userActivity.push({
                            type: 'connection',
                            time: new Date(conn.created_at),
                            title: 'WiFi Connection',
                            description: `${conn.plan || '4'} hour plan activated`,
                            status: conn.status,
                            icon: 'fa-wifi'
                        });
                    });
                }
                
                // Add speed tests
                if (speedTests) {
                    speedTests.forEach(test => {
                        userActivity.push({
                            type: 'speed_test',
                            time: new Date(test.created_at),
                            title: 'Speed Test',
                            description: `${test.download_speed.toFixed(1)} Mbps download speed`,
                            status: 'completed',
                            icon: 'fa-tachometer-alt'
                        });
                    });
                }
                
                // Add payments
                if (payments) {
                    payments.forEach(payment => {
                        userActivity.push({
                            type: 'payment',
                            time: new Date(payment.created_at),
                            title: 'Payment',
                            description: `KES ${payment.amount} payment ${payment.status}`,
                            status: payment.status,
                            icon: 'fa-credit-card'
                        });
                    });
                }
                
                // Sort by time
                userActivity.sort((a, b) => b.time - a.time);
                userActivity = userActivity.slice(0, 10);
                
            } catch (error) {
                console.error('âŒ Error loading user activity:', error);
            }
        }

        // Load Alerts
        async function loadAlerts() {
            try {
                const { data, error } = await supabase
                    .from('system_alerts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .or('status.eq.active,status.eq.new')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) {
                    console.warn('âš ï¸ Alerts not available:', error.message);
                    return [];
                }
                
                return data || [];
                
            } catch (error) {
                console.error('âŒ Error loading alerts:', error);
                return [];
            }
        }

        // Initialize Charts
        function initializeAllCharts() {
            // Performance Chart
            charts.performance = new ApexCharts(document.querySelector("#performanceChart"), {
                series: [{
                    name: 'Download Speed',
                    data: generatePerformanceData('download')
                }, {
                    name: 'Upload Speed',
                    data: generatePerformanceData('upload')
                }, {
                    name: 'Latency',
                    data: generatePerformanceData('latency')
                }],
                chart: {
                    height: 320,
                    type: 'line',
                    zoom: { enabled: false },
                    toolbar: { show: true }
                },
                colors: ['#0066FF', '#00D4AA', '#FF6B6B'],
                stroke: {
                    width: [3, 3, 2],
                    curve: 'smooth'
                },
                markers: {
                    size: [5, 5, 3]
                },
                xaxis: {
                    type: 'datetime',
                    categories: generateTimeLabels(24)
                },
                yaxis: [
                    {
                        title: { text: 'Speed (Mbps)' },
                        min: 0,
                        max: 100
                    },
                    {
                        opposite: true,
                        title: { text: 'Latency (ms)' },
                        min: 0,
                        max: 100
                    }
                ],
                tooltip: {
                    shared: true,
                    intersect: false,
                    y: {
                        formatter: function (value, { seriesIndex }) {
                            return seriesIndex === 2 ? value + ' ms' : value + ' Mbps';
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'left'
                }
            });
            
            charts.performance.render();
            
            // Device Chart
            charts.device = new ApexCharts(document.querySelector("#deviceChart"), {
                series: [65, 25, 10],
                chart: {
                    type: 'donut',
                    height: 200
                },
                colors: ['#0066FF', '#00D4AA', '#FF6B6B'],
                labels: ['Mobile', 'Laptop', 'Tablet'],
                plotOptions: {
                    pie: {
                        donut: {
                            size: '70%',
                            labels: {
                                show: true,
                                total: {
                                    show: true,
                                    label: 'Devices',
                                    fontSize: '14px'
                                }
                            }
                        }
                    }
                },
                legend: {
                    position: 'bottom'
                }
            });
            
            charts.device.render();
            
            // Usage Chart
            charts.usage = new ApexCharts(document.querySelector("#usageChart"), {
                series: [45, 25, 15, 10, 5],
                chart: {
                    type: 'donut',
                    height: 280
                },
                colors: ['#0066FF', '#00D4AA', '#FFB800', '#FF6B6B', '#9B51E0'],
                labels: ['Streaming', 'Downloads', 'Web Browsing', 'Gaming', 'Other'],
                plotOptions: {
                    pie: {
                        donut: {
                            size: '65%',
                            labels: {
                                show: true,
                                name: { fontSize: '14px' },
                                value: {
                                    fontSize: '20px',
                                    fontWeight: 'bold',
                                    formatter: function (val) {
                                        return val + '%';
                                    }
                                },
                                total: {
                                    show: true,
                                    label: 'Total Usage',
                                    fontSize: '14px',
                                    formatter: function (w) {
                                        return '100%';
                                    }
                                }
                            }
                        }
                    }
                },
                legend: {
                    show: false
                }
            });
            
            charts.usage.render();
            
            // Speed Mini Chart
            charts.speedMini = new ApexCharts(document.querySelector("#speedMiniChart"), {
                series: [{
                    name: 'Speed',
                    data: generateMiniChartData()
                }],
                chart: {
                    type: 'area',
                    height: 60,
                    width: 120,
                    sparkline: { enabled: true },
                    toolbar: { show: false }
                },
                colors: ['#0066FF'],
                stroke: { curve: 'smooth', width: 2 },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.3,
                        opacityTo: 0.1,
                        stops: [0, 100]
                    }
                },
                tooltip: { enabled: false }
            });
            
            charts.speedMini.render();
        }

        // Update Real-time Stats
        function updateRealTimeStats() {
            // Current Speed
            const latestSpeed = speedTestHistory[0];
            if (latestSpeed) {
                const downloadSpeed = Math.round(latestSpeed.download_speed);
                const uploadSpeed = Math.round(latestSpeed.upload_speed);
                document.getElementById('currentSpeed').textContent = downloadSpeed + ' Mbps';
                document.getElementById('uploadSpeed').textContent = uploadSpeed + ' Mbps';
                document.getElementById('downloadSpeed').textContent = downloadSpeed + ' Mbps';
                document.getElementById('uploadSpeedGauge').textContent = uploadSpeed + ' Mbps';
            }
            
            // Data Used
            const today = new Date().toISOString().split('T')[0];
            const todayUsage = usageHistory.find(u => u.date === today);
            if (todayUsage) {
                const usedGB = todayUsage.download_gb + todayUsage.upload_gb;
                document.getElementById('dataUsed').textContent = usedGB.toFixed(1) + ' GB';
                document.getElementById('dataRemaining').textContent = (50 - usedGB).toFixed(1) + ' GB';
                document.getElementById('dataProgress').style.width = ((usedGB / 50) * 100) + '%';
            }
            
            // Update other stats based on user connections
            const activeConnections = userConnections.filter(c => c.status === 'active').length;
            document.getElementById('daysLeft').textContent = Math.floor(Math.random() * 30) + 1;
            
            // Ping & Jitter (simulated)
            document.getElementById('pingValue').textContent = Math.floor(Math.random() * 30) + 20 + ' ms';
            document.getElementById('jitterValue').textContent = Math.floor(Math.random() * 10) + 2 + ' ms';
        }

        // Update Connection Status
        function updateConnectionStatus() {
            const latestConnection = userConnections[0];
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (latestConnection && latestConnection.status === 'active') {
                statusIndicator.className = 'cs-status-indicator large connected';
                statusText.textContent = 'Connected';
                statusIndicator.querySelector('i').style.color = '#10B981';
                
                // Update connection details
                document.getElementById('ipAddress').textContent = latestConnection.ip_address || '192.168.1.100';
                
                // Calculate connection duration
                const connectedTime = new Date(latestConnection.created_at);
                const now = new Date();
                const hours = Math.floor((now - connectedTime) / (1000 * 60 * 60));
                const minutes = Math.floor((now - connectedTime) / (1000 * 60)) % 60;
                document.getElementById('connectedSince').textContent = 
                    hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            } else {
                statusIndicator.className = 'cs-status-indicator large';
                statusText.textContent = 'Disconnected';
                statusIndicator.querySelector('i').style.color = '#EF4444';
                
                document.getElementById('ipAddress').textContent = '--';
                document.getElementById('connectedSince').textContent = '--';
            }
        }

        // Update Activity Timeline
        function updateActivityTimeline() {
            const timeline = document.getElementById('activityTimeline');
            timeline.innerHTML = '';
            
            if (userActivity.length === 0) {
                timeline.innerHTML = '<div class="cs-activity-item"><p style="color: var(--gray-500); text-align: center;">No recent activity</p></div>';
                return;
            }
            
            userActivity.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'cs-activity-item';
                
                const timeStr = formatTimeAgo(activity.time);
                const icon = activity.icon || 'fa-circle';
                
                item.innerHTML = `
                    <div class="cs-activity-time">${timeStr}</div>
                    <div class="cs-activity-title">
                        <i class="fas ${icon}"></i> ${activity.title}
                    </div>
                    <div class="cs-activity-desc">${activity.description}</div>
                `;
                
                timeline.appendChild(item);
            });
        }

        // Update Speed History
        function updateSpeedHistory() {
            const historyList = document.getElementById('speedHistoryList');
            historyList.innerHTML = '';
            
            speedTestHistory.slice(0, 5).forEach(test => {
                const item = document.createElement('div');
                item.className = 'cs-history-item';
                
                const time = new Date(test.created_at);
                const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                item.innerHTML = `
                    <div class="cs-history-time">Today, ${timeStr}</div>
                    <div class="cs-history-speed">${Math.round(test.download_speed)} Mbps</div>
                `;
                
                historyList.appendChild(item);
            });
        }

        // Update Alerts List
        async function updateAlertsList() {
            const alertsList = document.getElementById('alertsList');
            const alerts = await loadAlerts();
            
            alertsList.innerHTML = '';
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="cs-alert-item"><p style="color: var(--gray-500);">No active alerts</p></div>';
                return;
            }
            
            alerts.forEach(alert => {
                const item = document.createElement('div');
                item.className = 'cs-alert-item';
                
                let icon = 'fa-info-circle';
                if (alert.severity === 'high') icon = 'fa-exclamation-triangle';
                if (alert.severity === 'medium') icon = 'fa-exclamation-circle';
                
                item.innerHTML = `
                    <i class="fas ${icon} cs-alert-icon"></i>
                    <div class="cs-alert-content">
                        <h4>${alert.title}</h4>
                        <p>${alert.message}</p>
                    </div>
                `;
                
                alertsList.appendChild(item);
            });
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Refresh Button
            document.getElementById('refreshBtn').addEventListener('click', () => {
                location.reload();
            });
            
            // Speed Test Button
            document.getElementById('speedTestBtn').addEventListener('click', runSpeedTest);
            
            // Quick Action Buttons
            document.getElementById('topUpBtn').addEventListener('click', () => {
                window.location.href = 'billing.html#topup';
            });
            
            document.getElementById('invoiceBtn').addEventListener('click', () => {
                window.location.href = 'billing.html#invoices';
            });
            
            document.getElementById('supportBtn').addEventListener('click', () => {
                window.location.href = 'tickets.html';
            });
            
            document.getElementById('devicesBtn').addEventListener('click', () => {
                window.location.href = 'services.html#devices';
            });
            
            // Logout Button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Time Range Selector
            document.getElementById('timeRange').addEventListener('change', (e) => {
                updatePerformanceChart(e.target.value);
            });
            
            // Usage Period Selector
            document.getElementById('usagePeriod').addEventListener('change', (e) => {
                updateUsageChart(e.target.value);
            });
        }

        // Run Speed Test
        async function runSpeedTest() {
            const btn = document.getElementById('speedTestBtn');
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            btn.disabled = true;
            
            try {
                // Show testing notification
                showNotification('Running speed test... This may take a few seconds.', 'info');
                
                // Simulate speed test (in real app, call your API)
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Generate realistic results
                const downloadSpeed = 40 + Math.random() * 30; // 40-70 Mbps
                const uploadSpeed = downloadSpeed * 0.3 + Math.random() * 10; // ~30% of download
                const ping = 20 + Math.random() * 20; // 20-40 ms
                const jitter = 2 + Math.random() * 5; // 2-7 ms
                
                // Save to database
                const { error } = await supabase
                    .from('speed_tests')
                    .insert([{
                        user_id: currentUser.id,
                        download_speed: downloadSpeed,
                        upload_speed: uploadSpeed,
                        ping: ping,
                        jitter: jitter,
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) throw error;
                
                // Update UI
                document.getElementById('currentSpeed').textContent = Math.round(downloadSpeed) + ' Mbps';
                document.getElementById('uploadSpeed').textContent = Math.round(uploadSpeed) + ' Mbps';
                document.getElementById('downloadSpeed').textContent = Math.round(downloadSpeed) + ' Mbps';
                document.getElementById('uploadSpeedGauge').textContent = Math.round(uploadSpeed) + ' Mbps';
                document.getElementById('pingValue').textContent = Math.round(ping) + ' ms';
                document.getElementById('jitterValue').textContent = Math.round(jitter) + ' ms';
                
                // Add to activity
                userActivity.unshift({
                    type: 'speed_test',
                    time: new Date(),
                    title: 'Speed Test',
                    description: `${Math.round(downloadSpeed)} Mbps download speed`,
                    status: 'completed',
                    icon: 'fa-tachometer-alt'
                });
                
                // Update history
                speedTestHistory.unshift({
                    download_speed: downloadSpeed,
                    upload_speed: uploadSpeed,
                    created_at: new Date().toISOString()
                });
                
                // Update charts
                updatePerformanceChart(document.getElementById('timeRange').value);
                updateActivityTimeline();
                updateSpeedHistory();
                
                // Show success notification
                showNotification(`Speed test completed: ${Math.round(downloadSpeed)} Mbps download`, 'success');
                
            } catch (error) {
                console.error('Speed test failed:', error);
                showNotification('Speed test failed. Please try again.', 'error');
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // Update Performance Chart
        function updatePerformanceChart(range) {
            // This would normally fetch new data based on range
            // For now, we'll update with new simulated data
            charts.performance.updateSeries([{
                name: 'Download Speed',
                data: generatePerformanceData('download', range)
            }, {
                name: 'Upload Speed',
                data: generatePerformanceData('upload', range)
            }, {
                name: 'Latency',
                data: generatePerformanceData('latency', range)
            }]);
        }

        // Update Usage Chart
        function updateUsageChart(period) {
            // This would normally fetch new usage data based on period
            // For now, we'll just update the chart title
            console.log('Updating usage chart for:', period);
        }

        // Handle Logout
        async function handleLogout(e) {
            e.preventDefault();
            
            try {
                await supabase.auth.signOut();
                localStorage.removeItem('cs_session');
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout failed:', error);
                showNotification('Logout failed. Please try again.', 'error');
            }
        }

        // Start Real-time Updates
        function startRealTimeUpdates() {
            // Update time every minute
            setInterval(() => {
                updateRealTimeStats();
            }, 60000);
            
            // Check for new alerts every 5 minutes
            setInterval(async () => {
                await updateAlertsList();
            }, 300000);
        }

        // Helper Functions
        function generateSpeedTestData() {
            const tests = [];
            const now = new Date();
            
            for (let i = 0; i < 6; i++) {
                const time = new Date(now.getTime() - (i * 4 * 60 * 60 * 1000));
                tests.push({
                    download_speed: 30 + Math.random() * 40,
                    upload_speed: 10 + Math.random() * 20,
                    ping: 20 + Math.random() * 20,
                    jitter: 2 + Math.random() * 5,
                    created_at: time.toISOString()
                });
            }
            
            return tests;
        }

        function generateUsageData() {
            const usage = [];
            const now = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
                usage.push({
                    date: date.toISOString().split('T')[0],
                    download_gb: 2 + Math.random() * 3,
                    upload_gb: 0.5 + Math.random() * 0.5
                });
            }
            
            return usage;
        }

        function generatePerformanceData(type, range = '24h') {
            const data = [];
            const now = new Date();
            let points = 24;
            
            if (range === '7d') points = 7;
            if (range === '30d') points = 30;
            
            for (let i = points - 1; i >= 0; i--) {
                const time = new Date(now.getTime() - (i * (24 * 60 * 60 * 1000) / points));
                
                let value;
                if (type === 'download') {
                    value = 40 + Math.random() * 30;
                } else if (type === 'upload') {
                    value = 15 + Math.random() * 15;
                } else {
                    value = 20 + Math.random() * 20;
                }
                
                data.push({
                    x: time.getTime(),
                    y: Math.round(value * 10) / 10
                });
            }
            
            return data;
        }

        function generateTimeLabels(points) {
            const labels = [];
            const now = new Date();
            
            for (let i = points - 1; i >= 0; i--) {
                const time = new Date(now.getTime() - (i * (24 * 60 * 60 * 1000) / points));
                labels.push(time.getTime());
            }
            
            return labels;
        }

        function generateMiniChartData() {
            const data = [];
            for (let i = 0; i < 10; i++) {
                data.push(40 + Math.random() * 20);
            }
            return data;
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        function showNotification(message, type = 'info') {
            const notificationCenter = document.getElementById('notificationCenter');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <div style="flex: 1;">
                    <p style="margin: 0; font-weight: 600;">${type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Info'}</p>
                    <p style="margin: 4px 0 0; font-size: 14px;">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--gray-500); cursor: pointer; padding: 4px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            notificationCenter.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function showError(message) {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.innerHTML = `
                <div class="cs-loading-content">
                    <div style="color: var(--danger); font-size: 3rem; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2>Dashboard Error</h2>
                    <p>${message}</p>
                    <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin: 20px auto 0;">
                        <i class="fas fa-redo"></i> Refresh Page
                    </button>
                </div>
            `;
        }
    </script>
</body>
    </html>
