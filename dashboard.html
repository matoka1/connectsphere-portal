<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ConnectSphere</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="cs-loading-screen">
        <div class="cs-loading-content">
            <div class="cs-loading-spinner"></div>
            <h2>ConnectSphere Portal</h2>
            <p>Loading Dashboard...</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" style="display: none;">
        <!-- Navigation -->
        <nav class="cs-navbar">
            <div class="cs-navbar-brand">
                <i class="fas fa-wifi"></i>
                <span>ConnectSphere</span>
            </div>
            
            <div class="cs-navbar-menu">
                <a href="index.html" class="cs-nav-item">
                    <i class="fas fa-home"></i>
                    <span>Portal</span>
                </a>
                <a href="dashboard.html" class="cs-nav-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="services.html" class="cs-nav-item">
                    <i class="fas fa-wifi"></i>
                    <span>Services</span>
                </a>
                <a href="billing.html" class="cs-nav-item">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Billing</span>
                </a>
                <a href="tickets.html" class="cs-nav-item">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Support</span>
                </a>
                <div class="cs-nav-item dropdown">
                    <i class="fas fa-user-circle"></i>
                    <span id="navUserName">Profile</span>
                    <div class="cs-dropdown-menu">
                        <a href="profile.html"><i class="fas fa-user"></i> My Profile</a>
                        <a href="#"><i class="fas fa-cog"></i> Settings</a>
                        <div class="cs-divider"></div>
                        <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="cs-main-content">
            <div class="cs-container">
                <!-- Dashboard Header -->
                <div class="cs-dashboard-header">
                    <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
                    <p>Welcome back, <span id="userName">User</span>! Here's your connection overview.</p>
                </div>

                <!-- Quick Stats -->
                <div class="cs-stats-grid">
                    <div class="cs-stat-card">
                        <div class="cs-stat-icon">
                            <i class="fas fa-signal"></i>
                        </div>
                        <div class="cs-stat-content">
                            <h3 id="currentSpeed">Loading...</h3>
                            <p>Current Speed</p>
                        </div>
                    </div>
                    
                    <div class="cs-stat-card">
                        <div class="cs-stat-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="cs-stat-content">
                            <h3 id="dataUsed">Loading...</h3>
                            <p>Data Used Today</p>
                        </div>
                    </div>
                    
                    <div class="cs-stat-card">
                        <div class="cs-stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="cs-stat-content">
                            <h3 id="uptime">Loading...</h3>
                            <p>Network Uptime</p>
                        </div>
                    </div>
                    
                    <div class="cs-stat-card">
                        <div class="cs-stat-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="cs-stat-content">
                            <h3 id="daysLeft">Loading...</h3>
                            <p>Billing Cycle</p>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="cs-charts-section">
                    <div class="cs-chart-container">
                        <div class="cs-chart-header">
                            <h3><i class="fas fa-chart-line"></i> Data Usage (Last 7 Days)</h3>
                            <select id="chartRange" onchange="updateChart()">
                                <option value="7">7 Days</option>
                                <option value="30">30 Days</option>
                                <option value="90">90 Days</option>
                            </select>
                        </div>
                        <canvas id="usageChart" height="300"></canvas>
                    </div>
                    
                    <div class="cs-chart-container">
                        <div class="cs-chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Speed Test History</h3>
                        </div>
                        <canvas id="speedChart" height="300"></canvas>
                    </div>
                </div>

                <!-- Connection Status -->
                <div class="cs-status-card">
                    <div class="cs-status-header">
                        <h3><i class="fas fa-network-wired"></i> Connection Status</h3>
                        <div class="cs-status-indicator" id="statusIndicator">
                            <i class="fas fa-circle"></i>
                            <span id="statusText">Checking...</span>
                        </div>
                    </div>
                    
                    <div class="cs-status-details">
                        <div class="cs-status-item">
                            <span class="cs-status-label">IP Address:</span>
                            <span class="cs-status-value" id="ipAddress">Loading...</span>
                        </div>
                        <div class="cs-status-item">
                            <span class="cs-status-label">MAC Address:</span>
                            <span class="cs-status-value" id="macAddress">Loading...</span>
                        </div>
                        <div class="cs-status-item">
                            <span class="cs-status-label">Connected Since:</span>
                            <span class="cs-status-value" id="connectedSince">Loading...</span>
                        </div>
                        <div class="cs-status-item">
                            <span class="cs-status-label">Session Expires:</span>
                            <span class="cs-status-value" id="sessionExpires">Loading...</span>
                        </div>
                    </div>
                    
                    <button class="cs-disconnect-btn" id="disconnectBtn">
                        <i class="fas fa-power-off"></i> Disconnect
                    </button>
                </div>

                <!-- Recent Activity -->
                <div class="cs-recent-activity">
                    <h3><i class="fas fa-history"></i> Recent Activity</h3>
                    <div class="cs-activity-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Activity</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="activityTable">
                                <tr><td colspan="4" style="text-align: center;">Loading activity...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="cs-quick-actions">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                    <div class="cs-action-buttons">
                        <button class="cs-action-btn" id="speedTestBtn">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Speed Test</span>
                        </button>
                        <button class="cs-action-btn" id="topUpBtn">
                            <i class="fas fa-plus-circle"></i>
                            <span>Top Up Data</span>
                        </button>
                        <button class="cs-action-btn" id="invoiceBtn">
                            <i class="fas fa-file-invoice"></i>
                            <span>View Invoice</span>
                        </button>
                        <button class="cs-action-btn" id="supportBtn">
                            <i class="fas fa-question-circle"></i>
                            <span>Get Help</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="cs-footer">
            <div class="cs-footer-content">
                <div class="cs-footer-brand">
                    <i class="fas fa-wifi"></i>
                    <span>ConnectSphere</span>
                </div>
                <p>Enterprise WiFi Management Platform</p>
                <div class="cs-footer-links">
                    <a href="#">Terms of Service</a>
                    <a href="#">Privacy Policy</a>
                    <a href="#">Contact Us</a>
                    <a href="#">Support</a>
                </div>
                <p class="cs-copyright">Â© 2024 ConnectSphere. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://uadbyyaxlieemfaofode.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhZGJ5eWF4bGllZW1mYW9mb2RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MDMyODUsImV4cCI6MjA4MTM3OTI4NX0.Gh3J0GpdQ8yXU-976JNjJKuY6rkBvn3Vkllq2vz37No';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Global Variables
        let currentUser = null;
        let userConnections = [];
        let userActivity = [];
        let speedTestHistory = [];
        let usageHistory = [];

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸ”µ Initializing dashboard...');
            
            try {
                // Check authentication
                await checkAuth();
                
                // Load all dashboard data
                await loadDashboardData();
                
                // Initialize charts with real data
                await initializeCharts();
                
                // Set up event listeners
                setupEventListeners();
                
                // Hide loading screen, show app
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                console.log('âœ… Dashboard initialized successfully');
                
            } catch (error) {
                console.error('âŒ Dashboard initialization failed:', error);
                showError('Failed to load dashboard. Please refresh the page.');
            }
        });

        // Authentication Check
        async function checkAuth() {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error || !session) {
                console.error('âŒ No valid session found:', error);
                // Redirect to login page
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = session.user;
            console.log('âœ… User authenticated:', currentUser.email);
            
            // Update user name display
            const userName = currentUser.user_metadata?.full_name || 
                           currentUser.user_metadata?.first_name || 
                           currentUser.email.split('@')[0];
            
            document.getElementById('userName').textContent = userName;
            document.getElementById('navUserName').textContent = userName.split(' ')[0]; // First name only for nav
        }

        // Load Dashboard Data from Supabase
        async function loadDashboardData() {
            console.log('ðŸ”µ Loading dashboard data...');
            
            if (!currentUser) {
                throw new Error('User not authenticated');
            }
            
            try {
                // Load user connections
                const { data: connections, error: connectionsError } = await supabase
                    .from('wifi_connections')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (connectionsError) throw connectionsError;
                userConnections = connections || [];
                console.log('âœ… Loaded connections:', userConnections.length);
                
                // Load user activity (from connections and other sources)
                await loadUserActivity();
                
                // Load speed test history
                await loadSpeedTestHistory();
                
                // Load usage history
                await loadUsageHistory();
                
                // Update all dashboard components
                updateQuickStats();
                updateConnectionStatus();
                updateRecentActivity();
                
            } catch (error) {
                console.error('âŒ Error loading dashboard data:', error);
                throw error;
            }
        }

        // Load User Activity
        async function loadUserActivity() {
            // Combine connections, speed tests, payments, etc.
            userActivity = [];
            
            // Add connections as activity
            userConnections.forEach(conn => {
                userActivity.push({
                    time: new Date(conn.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    activity: 'WiFi Connection',
                    details: `${conn.plan} hour plan via ${conn.payment_method}`,
                    status: conn.status,
                    timestamp: new Date(conn.created_at)
                });
            });
            
            // Sort by timestamp (newest first)
            userActivity.sort((a, b) => b.timestamp - a.timestamp);
            
            // Keep only last 10 activities
            userActivity = userActivity.slice(0, 10);
        }

        // Load Speed Test History
        async function loadSpeedTestHistory() {
            // In a real app, you would have a speed_tests table
            // For now, we'll simulate with random data
            speedTestHistory = [
                { time: '6 AM', download: 45 + Math.random() * 10, upload: 15 + Math.random() * 5 },
                { time: '9 AM', download: 38 + Math.random() * 10, upload: 12 + Math.random() * 5 },
                { time: '12 PM', download: 42 + Math.random() * 10, upload: 14 + Math.random() * 5 },
                { time: '3 PM', download: 35 + Math.random() * 10, upload: 10 + Math.random() * 5 },
                { time: '6 PM', download: 48 + Math.random() * 10, upload: 16 + Math.random() * 5 },
                { time: '9 PM', download: 40 + Math.random() * 10, upload: 13 + Math.random() * 5 }
            ];
        }

        // Load Usage History
        async function loadUsageHistory() {
            // In a real app, you would query usage data from your database
            // For now, we'll simulate with realistic data
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            usageHistory = days.map(day => ({
                day,
                download: 2 + Math.random() * 3, // 2-5 GB
                upload: 0.5 + Math.random() * 0.5 // 0.5-1 GB
            }));
        }

        // Update Quick Stats
        function updateQuickStats() {
            console.log('ðŸ”µ Updating quick stats...');
            
            // Current Speed (from latest connection or speed test)
            const latestSpeed = speedTestHistory.length > 0 
                ? Math.round(speedTestHistory[speedTestHistory.length - 1].download)
                : 25;
            document.getElementById('currentSpeed').textContent = `${latestSpeed} Mbps`;
            
            // Data Used Today (simulated)
            const todayUsage = usageHistory[0]?.download || 4.2;
            document.getElementById('dataUsed').textContent = `${todayUsage.toFixed(1)} GB`;
            
            // Network Uptime (from connections)
            const totalConnections = userConnections.length;
            const successfulConnections = userConnections.filter(c => c.status === 'active' || c.status === 'completed').length;
            const uptimePercentage = totalConnections > 0 ? (successfulConnections / totalConnections) * 100 : 98.5;
            document.getElementById('uptime').textContent = `${uptimePercentage.toFixed(1)}%`;
            
            // Billing Cycle (simulated - would come from subscriptions table)
            const daysLeft = 15; // This would come from user's subscription data
            document.getElementById('daysLeft').textContent = `${daysLeft} Days`;
        }

        // Update Connection Status
        function updateConnectionStatus() {
            console.log('ðŸ”µ Updating connection status...');
            
            const latestConnection = userConnections[0];
            
            if (latestConnection) {
                // Update status indicator
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                if (latestConnection.status === 'active') {
                    statusIndicator.className = 'cs-status-indicator connected';
                    statusText.textContent = 'Connected';
                } else {
                    statusIndicator.className = 'cs-status-indicator';
                    statusIndicator.style.background = 'rgba(245, 158, 11, 0.1)';
                    statusIndicator.style.color = 'var(--warning)';
                    statusIndicator.querySelector('i').style.color = 'var(--warning)';
                    statusText.textContent = 'Disconnected';
                }
                
                // Update connection details
                document.getElementById('ipAddress').textContent = latestConnection.ip_address || '192.168.1.100';
                document.getElementById('macAddress').textContent = latestConnection.mac_address || '00:1A:2B:3C:4D:5E';
                
                // Calculate time since connection
                const connectedTime = new Date(latestConnection.created_at);
                const now = new Date();
                const hoursDiff = Math.floor((now - connectedTime) / (1000 * 60 * 60));
                const minutesDiff = Math.floor((now - connectedTime) / (1000 * 60)) % 60;
                
                document.getElementById('connectedSince').textContent = 
                    hoursDiff > 0 ? `${hoursDiff}h ${minutesDiff}m ago` : `${minutesDiff}m ago`;
                
                // Calculate session expiry
                const planHours = parseInt(latestConnection.plan) || 4;
                const expiryTime = new Date(connectedTime.getTime() + (planHours * 60 * 60 * 1000));
                const timeLeft = expiryTime - now;
                
                if (timeLeft > 0) {
                    const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutesLeft = Math.floor((timeLeft / (1000 * 60)) % 60);
                    document.getElementById('sessionExpires').textContent = 
                        `in ${hoursLeft}h ${minutesLeft}m`;
                } else {
                    document.getElementById('sessionExpires').textContent = 'Expired';
                }
            }
        }

        // Update Recent Activity
        function updateRecentActivity() {
            console.log('ðŸ”µ Updating recent activity...');
            
            const table = document.getElementById('activityTable');
            table.innerHTML = '';
            
            if (userActivity.length === 0) {
                table.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--gray-500);">No recent activity</td></tr>';
                return;
            }
            
            userActivity.forEach(activity => {
                const row = document.createElement('tr');
                
                // Determine status class
                let statusClass = 'completed';
                if (activity.status === 'pending') statusClass = 'pending';
                if (activity.status === 'failed') statusClass = 'error';
                
                row.innerHTML = `
                    <td>${activity.time}</td>
                    <td>${activity.activity}</td>
                    <td>${activity.details}</td>
                    <td><span class="cs-status-badge ${statusClass}">${activity.status}</span></td>
                `;
                table.appendChild(row);
            });
        }

        // Initialize Charts with Real Data
        async function initializeCharts() {
            console.log('ðŸ”µ Initializing charts...');
            
            // Usage Chart
            const usageCtx = document.getElementById('usageChart').getContext('2d');
            window.usageChart = new Chart(usageCtx, {
                type: 'line',
                data: {
                    labels: usageHistory.map(d => d.day),
                    datasets: [{
                        label: 'Download (GB)',
                        data: usageHistory.map(d => d.download),
                        borderColor: '#0066FF',
                        backgroundColor: 'rgba(0, 102, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Upload (GB)',
                        data: usageHistory.map(d => d.upload),
                        borderColor: '#00D4AA',
                        backgroundColor: 'rgba(0, 212, 170, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} GB`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Data Usage (GB)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' GB';
                                }
                            }
                        }
                    }
                }
            });

            // Speed Chart
            const speedCtx = document.getElementById('speedChart').getContext('2d');
            window.speedChart = new Chart(speedCtx, {
                type: 'bar',
                data: {
                    labels: speedTestHistory.map(d => d.time),
                    datasets: [{
                        label: 'Download Speed (Mbps)',
                        data: speedTestHistory.map(d => d.download),
                        backgroundColor: 'rgba(0, 102, 255, 0.7)',
                        borderColor: '#0066FF',
                        borderWidth: 1
                    }, {
                        label: 'Upload Speed (Mbps)',
                        data: speedTestHistory.map(d => d.upload),
                        backgroundColor: 'rgba(0, 212, 170, 0.7)',
                        borderColor: '#00D4AA',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)} Mbps`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Speed (Mbps)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' Mbps';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update Chart based on range selection
        function updateChart() {
            const range = parseInt(document.getElementById('chartRange').value);
            console.log(`Updating chart for ${range} days`);
            
            // In a real app, you would fetch data for the selected range
            // For now, we'll just update the chart title
            document.querySelector('#usageChart').previousElementSibling
                .querySelector('h3').innerHTML = `<i class="fas fa-chart-line"></i> Data Usage (Last ${range} Days)`;
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Disconnect Button
            document.getElementById('disconnectBtn').addEventListener('click', disconnect);
            
            // Quick Action Buttons
            document.getElementById('speedTestBtn').addEventListener('click', runSpeedTest);
            document.getElementById('topUpBtn').addEventListener('click', topUpData);
            document.getElementById('invoiceBtn').addEventListener('click', viewInvoice);
            document.getElementById('supportBtn').addEventListener('click', openSupport);
            
            // Logout Button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        }

        // Run Speed Test
        async function runSpeedTest() {
            try {
                // Show loading
                const btn = document.getElementById('speedTestBtn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                btn.disabled = true;
                
                // Simulate speed test (in real app, this would call your speed test API)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Generate random speed results
                const downloadSpeed = 30 + Math.random() * 40; // 30-70 Mbps
                const uploadSpeed = downloadSpeed * 0.3 + Math.random() * 10; // 30% of download + random
                
                // Save speed test to database (in real app)
                // const { error } = await supabase
                //     .from('speed_tests')
                //     .insert([{
                //         user_id: currentUser.id,
                //         download_speed: downloadSpeed,
                //         upload_speed: uploadSpeed,
                //         created_at: new Date().toISOString()
                //     }]);
                
                // Update UI
                document.getElementById('currentSpeed').textContent = `${Math.round(downloadSpeed)} Mbps`;
                
                // Add to activity
                userActivity.unshift({
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    activity: 'Speed Test',
                    details: `${Math.round(downloadSpeed)} Mbps download, ${Math.round(uploadSpeed)} Mbps upload`,
                    status: 'Completed',
                    timestamp: new Date()
                });
                
                // Update charts
                speedTestHistory.push({
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    download: downloadSpeed,
                    upload: uploadSpeed
                });
                
                // Keep only last 6 entries
                if (speedTestHistory.length > 6) {
                    speedTestHistory = speedTestHistory.slice(-6);
                }
                
                // Refresh charts and activity
                window.speedChart.data.datasets[0].data = speedTestHistory.map(d => d.download);
                window.speedChart.data.datasets[1].data = speedTestHistory.map(d => d.upload);
                window.speedChart.update();
                updateRecentActivity();
                
                // Show notification
                showNotification(`Speed test completed: ${Math.round(downloadSpeed)} Mbps download`, 'success');
                
            } catch (error) {
                console.error('Speed test failed:', error);
                showNotification('Speed test failed. Please try again.', 'error');
            } finally {
                // Reset button
                const btn = document.getElementById('speedTestBtn');
                btn.innerHTML = '<i class="fas fa-tachometer-alt"></i><span>Speed Test</span>';
                btn.disabled = false;
            }
        }

        // Top Up Data
        function topUpData() {
            window.location.href = 'billing.html#topup';
        }

        // View Invoice
        function viewInvoice() {
            window.location.href = 'billing.html#invoices';
        }

        // Open Support
        function openSupport() {
            window.location.href = 'tickets.html';
        }

        // Disconnect Function
        async function disconnect() {
            if (!confirm('Are you sure you want to disconnect your current session?')) {
                return;
            }
            
            try {
                // Find active connection
                const activeConnection = userConnections.find(c => c.status === 'active');
                
                if (activeConnection) {
                    // Update connection status in database
                    const { error } = await supabase
                        .from('wifi_connections')
                        .update({ 
                            status: 'disconnected',
                            connection_end: new Date().toISOString()
                        })
                        .eq('id', activeConnection.id);
                    
                    if (error) throw error;
                    
                    // Update local data
                    activeConnection.status = 'disconnected';
                    
                    // Update UI
                    updateConnectionStatus();
                    updateRecentActivity();
                    
                    showNotification('Disconnected successfully', 'success');
                } else {
                    showNotification('No active connection found', 'info');
                }
                
            } catch (error) {
                console.error('Disconnect failed:', error);
                showNotification('Failed to disconnect. Please try again.', 'error');
            }
        }

        // Handle Logout
        async function handleLogout(e) {
            e.preventDefault();
            
            try {
                // Sign out from Supabase
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                // Clear local storage
                localStorage.removeItem('cs_session');
                
                // Redirect to home page
                window.location.href = 'index.html';
                
            } catch (error) {
                console.error('Logout failed:', error);
                alert('Logout failed. Please try again.');
            }
        }

        // Helper Functions
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function showError(message) {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.innerHTML = `
                <div class="cs-loading-content">
                    <div style="color: var(--danger); font-size: 3rem; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2>Dashboard Error</h2>
                    <p>${message}</p>
                    <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-redo"></i> Refresh Page
                    </button>
                </div>
            `;
        }
        // Add this function to fetch real activity data
async function loadRealActivity() {
    try {
        console.log('ðŸ”µ Loading real activity data...');
        
        if (!currentUser) {
            console.warn('âš ï¸ No user found for activity');
            return;
        }
        
        // Load user connections (should already have this)
        const { data: connections, error: connError } = await supabase
            .from('wifi_connections')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (connError) throw connError;
        
        // Load speed tests
        const { data: speedTests, error: speedError } = await supabase
            .from('speed_tests')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false })
            .limit(5);
        
        if (speedError) console.warn('âš ï¸ Speed tests not loaded:', speedError.message);
        
        // Combine all activities
        userActivity = [];
        
        // Add connections
        if (connections && connections.length > 0) {
            connections.forEach(conn => {
                userActivity.push({
                    time: new Date(conn.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    date: new Date(conn.created_at),
                    activity: 'WiFi Connection',
                    details: `${conn.plan || '4'} hour plan via ${conn.payment_method || 'M-Pesa'}`,
                    status: conn.status || 'completed',
                    timestamp: new Date(conn.created_at)
                });
            });
        }
        
        // Add speed tests
        if (speedTests && speedTests.length > 0) {
            speedTests.forEach(test => {
                userActivity.push({
                    time: new Date(test.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    date: new Date(test.created_at),
                    activity: 'Speed Test',
                    details: `${test.download_speed.toFixed(1)} Mbps download, ${test.upload_speed.toFixed(1)} Mbps upload`,
                    status: 'completed',
                    timestamp: new Date(test.created_at)
                });
            });
        }
        
        // Sort by timestamp (newest first)
        userActivity.sort((a, b) => b.timestamp - a.timestamp);
        
        // Keep only last 10 activities
        userActivity = userActivity.slice(0, 10);
        
        console.log('âœ… Loaded', userActivity.length, 'activities');
        
    } catch (error) {
        console.error('âŒ Error loading activity:', error);
    }
}

// Update the loadUserActivity function
async function loadUserActivity() {
    await loadRealActivity();
}

// Update the loadDashboardData function to load real data
async function loadDashboardData() {
    console.log('ðŸ”µ Loading comprehensive dashboard data...');
    
    if (!currentUser) {
        throw new Error('User not authenticated');
    }
    
    try {
        // Load user profile for name
        const { data: userProfile, error: profileError } = await supabase
            .from('users')
            .select('*')
            .eq('id', currentUser.id)
            .single();
        
        if (!profileError && userProfile) {
            // Display full name if available
            const fullName = userProfile.first_name && userProfile.last_name 
                ? `${userProfile.first_name} ${userProfile.last_name}`
                : currentUser.user_metadata?.full_name 
                || currentUser.email?.split('@')[0] 
                || 'User';
            
            document.getElementById('userName').textContent = fullName;
        }
        
        // Load all data in parallel
        await Promise.all([
            loadRealConnections(),
            loadRealActivity(),
            loadRealSpeedTests(),
            loadRealUsageData()
        ]);
        
        // Update all UI components
        updateQuickStats();
        updateConnectionStatus();
        updateRecentActivity();
        
    } catch (error) {
        console.error('âŒ Error loading dashboard data:', error);
        throw error;
    }
}

// Add these new data loading functions
async function loadRealConnections() {
    try {
        const { data, error } = await supabase
            .from('wifi_connections')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false })
            .limit(5);
        
        if (error) throw error;
        
        userConnections = data || [];
        console.log('âœ… Loaded', userConnections.length, 'connections');
        
    } catch (error) {
        console.error('âŒ Error loading connections:', error);
        userConnections = [];
    }
}

async function loadRealSpeedTests() {
    try {
        const { data, error } = await supabase
            .from('speed_tests')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false })
            .limit(6);
        
        if (error) {
            console.warn('âš ï¸ Speed tests table might not exist:', error.message);
            // Fallback to simulated data
            speedTestHistory = generateSpeedTestData();
            return;
        }
        
        if (data && data.length > 0) {
            // Convert to chart format
            const times = ['6 AM', '9 AM', '12 PM', '3 PM', '6 PM', '9 PM'];
            speedTestHistory = data.slice(0, 6).map((test, index) => ({
                time: times[index] || new Date(test.created_at).toLocaleTimeString([], {hour: '2-digit'}),
                download: test.download_speed,
                upload: test.upload_speed
            }));
        } else {
            // Generate simulated data if no real data
            speedTestHistory = generateSpeedTestData();
        }
        
        console.log('âœ… Loaded speed test data');
        
    } catch (error) {
        console.error('âŒ Error loading speed tests:', error);
        speedTestHistory = generateSpeedTestData();
    }
}

async function loadRealUsageData() {
    try {
        const { data, error } = await supabase
            .from('data_usage')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('date', { ascending: true })
            .limit(7);
        
        if (error) {
            console.warn('âš ï¸ Data usage table might not exist:', error.message);
            // Fallback to simulated data
            usageHistory = generateUsageData();
            return;
        }
        
        if (data && data.length > 0) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            usageHistory = data.map(usage => ({
                day: days[new Date(usage.date).getDay()],
                download: usage.download_gb,
                upload: usage.upload_gb
            }));
        } else {
            // Generate simulated data if no real data
            usageHistory = generateUsageData();
        }
        
        console.log('âœ… Loaded usage data');
        
    } catch (error) {
        console.error('âŒ Error loading usage data:', error);
        usageHistory = generateUsageData();
    }
}

// Helper functions for simulated data
function generateSpeedTestData() {
    return [
        { time: '6 AM', download: 45 + Math.random() * 10, upload: 15 + Math.random() * 5 },
        { time: '9 AM', download: 38 + Math.random() * 10, upload: 12 + Math.random() * 5 },
        { time: '12 PM', download: 42 + Math.random() * 10, upload: 14 + Math.random() * 5 },
        { time: '3 PM', download: 35 + Math.random() * 10, upload: 10 + Math.random() * 5 },
        { time: '6 PM', download: 48 + Math.random() * 10, upload: 16 + Math.random() * 5 },
        { time: '9 PM', download: 40 + Math.random() * 10, upload: 13 + Math.random() * 5 }
    ];
}

function generateUsageData() {
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    return days.map(day => ({
        day,
        download: 2 + Math.random() * 3, // 2-5 GB
        upload: 0.5 + Math.random() * 0.5 // 0.5-1 GB
    }));
}

// Update the updateConnectionStatus function
function updateConnectionStatus() {
    console.log('ðŸ”µ Updating connection status...');
    
    const latestConnection = userConnections[0];
    
    if (latestConnection) {
        // Update status indicator
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        
        if (latestConnection.status === 'active') {
            statusIndicator.className = 'cs-status-indicator connected';
            statusText.textContent = 'Connected';
        } else {
            statusIndicator.className = 'cs-status-indicator';
            statusIndicator.style.background = 'rgba(245, 158, 11, 0.1)';
            statusIndicator.style.color = 'var(--warning)';
            statusIndicator.querySelector('i').style.color = 'var(--warning)';
            statusText.textContent = 'Disconnected';
        }
        
        // Update connection details with real data
        document.getElementById('ipAddress').textContent = latestConnection.ip_address || '192.168.1.100';
        document.getElementById('macAddress').textContent = latestConnection.mac_address || '00:1A:2B:3C:4D:5E';
        
        // Calculate time since connection
        const connectedTime = new Date(latestConnection.created_at);
        const now = new Date();
        const hoursDiff = Math.floor((now - connectedTime) / (1000 * 60 * 60));
        const minutesDiff = Math.floor((now - connectedTime) / (1000 * 60)) % 60;
        
        document.getElementById('connectedSince').textContent = 
            hoursDiff > 0 ? `${hoursDiff}h ${minutesDiff}m ago` : `${minutesDiff}m ago`;
        
        // Calculate session expiry
        const planHours = parseInt(latestConnection.plan) || 4;
        const expiryTime = new Date(connectedTime.getTime() + (planHours * 60 * 60 * 1000));
        const timeLeft = expiryTime - now;
        
        if (timeLeft > 0) {
            const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutesLeft = Math.floor((timeLeft / (1000 * 60)) % 60);
            document.getElementById('sessionExpires').textContent = 
                `in ${hoursLeft}h ${minutesLeft}m`;
        } else {
            document.getElementById('sessionExpires').textContent = 'Expired';
        }
        
    } else {
        // No connections found
        document.getElementById('statusText').textContent = 'No Connection';
        document.getElementById('ipAddress').textContent = 'Not connected';
        document.getElementById('macAddress').textContent = 'Not connected';
        document.getElementById('connectedSince').textContent = 'N/A';
        document.getElementById('sessionExpires').textContent = 'N/A';
    }
}

// Update the runSpeedTest function to save to database
async function runSpeedTest() {
    try {
        const btn = document.getElementById('speedTestBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        btn.disabled = true;
        
        // Show notification
        showNotification('Running speed test...', 'info');
        
        // Simulate speed test (in real app, this would call your speed test API)
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        // Generate realistic speed results
        const downloadSpeed = 30 + Math.random() * 40; // 30-70 Mbps
        const uploadSpeed = downloadSpeed * 0.3 + Math.random() * 10; // 30% of download + random
        
        // Save speed test to database
        const { error: saveError } = await supabase
            .from('speed_tests')
            .insert([{
                user_id: currentUser.id,
                download_speed: downloadSpeed,
                upload_speed: uploadSpeed,
                created_at: new Date().toISOString()
            }]);
        
        if (saveError) {
            console.warn('âš ï¸ Could not save speed test:', saveError.message);
            // Continue anyway - user will see the result
        }
        
        // Update current speed display
        document.getElementById('currentSpeed').textContent = `${Math.round(downloadSpeed)} Mbps`;
        
        // Add to activity
        userActivity.unshift({
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            activity: 'Speed Test',
            details: `${Math.round(downloadSpeed)} Mbps download, ${Math.round(uploadSpeed)} Mbps upload`,
            status: 'Completed',
            timestamp: new Date()
        });
        
        // Update speed test history for chart
        speedTestHistory.push({
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            download: downloadSpeed,
            upload: uploadSpeed
        });
        
        // Keep only last 6 entries
        if (speedTestHistory.length > 6) {
            speedTestHistory = speedTestHistory.slice(-6);
        }
        
        // Refresh charts and activity
        if (window.speedChart) {
            window.speedChart.data.datasets[0].data = speedTestHistory.map(d => d.download);
            window.speedChart.data.datasets[1].data = speedTestHistory.map(d => d.upload);
            window.speedChart.update();
        }
        
        updateRecentActivity();
        
        // Show success notification
        showNotification(`Speed test completed: ${Math.round(downloadSpeed)} Mbps download`, 'success');
        
    } catch (error) {
        console.error('Speed test failed:', error);
        showNotification('Speed test failed. Please try again.', 'error');
    } finally {
        const btn = document.getElementById('speedTestBtn');
        btn.innerHTML = '<i class="fas fa-tachometer-alt"></i><span>Speed Test</span>';
        btn.disabled = false;
    }
}
    </script>

    <!-- Add missing CSS classes -->
    <style>
        .cs-status-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .cs-status-badge.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            border-radius: var(--radius);
            padding: var(--space-md) var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            box-shadow: var(--shadow-lg);
            z-index: 1002;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }
        
        .notification.success {
            border-left: 4px solid var(--success);
        }
        
        .notification.error {
            border-left: 4px solid var(--danger);
        }
        
        .notification.info {
            border-left: 4px solid var(--info);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</body>
</html>
